<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pushup Tracker Web</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; color: white; font-family: Arial, sans-serif; }
        #video_container { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; }
        video { display: none; /* Hide the raw video, we only show the canvas */ }
        canvas { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        /* The UI Floating Overlays */
        #ui { position: absolute; top: 20px; left: 20px; text-shadow: 2px 2px 4px #000; }
        h1 { color: #00FF00; margin: 0 0 10px 0; font-size: 3rem; }
        p { margin: 5px 0; font-size: 1.2rem; font-weight: bold; }
        .warning { color: #FF0000; font-size: 2rem; display: none; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="video_container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
        <div id="ui">
            <h1 id="count_display">PUSHUPS: 0</h1>
            <p id="ground_display">On Ground: false</p>
            <p id="state_display">State: TOP</p>
            <div id="warning_display" class="warning">STAND DETECTED!</div>
        </div>
    </div>

    <script>
        // --- THE MATH ENGINES ---
        function calculateAngle(a, b, c) {
            let radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            return angle;
        }

        function calculateDistance(p1, p2) {
            return Math.sqrt(Math.pow(p1.x - p2.x, 2) + Math.pow(p1.y - p2.y, 2));
        }

        // --- UI ELEMENTS & VARIABLES ---
        const countEl = document.getElementById('count_display');
        const groundEl = document.getElementById('ground_display');
        const stateEl = document.getElementById('state_display');
        const warningEl = document.getElementById('warning_display');

        let count = 0;
        let direction = 0;

        const videoElement = document.getElementById('webcam');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');

        // --- THE AI PIPELINE (Runs every single frame) ---
        function onResults(results) {
            // Match the drawing canvas to the camera resolution
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            // Draw the video and the green skeleton
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.poseLandmarks) {
                drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#FFFFFF', lineWidth: 4});
                drawLandmarks(canvasCtx, results.poseLandmarks, {color: '#FF0000', lineWidth: 2, radius: 4});

                let landmarks = results.poseLandmarks;
                
                // Extract coordinates (MediaPipe JS array index mapping)
                // Nose: 0, L_Shoulder: 11, L_Elbow: 13, L_Wrist: 15, L_Hip: 23
                let nose = landmarks[0];
                let shoulder = landmarks[11];
                let elbow = landmarks[13];
                let wrist = landmarks[15];
                let hip = landmarks[23];

                // Confidence/Visibility Check
                if (shoulder.visibility > 0.4 && elbow.visibility > 0.4 && wrist.visibility > 0.4) {
                    
                    let angle = calculateAngle(shoulder, elbow, wrist);
                    let nose_wrist_dist = calculateDistance(nose, wrist);
                    
                    // --- THE GROUND ANCHOR FIX ---
                    let is_on_ground = wrist.y > hip.y;
                    groundEl.innerText = `On Ground: ${is_on_ground}`;

                    // --- THE MASTER STATE MACHINE ---
                    if (is_on_ground) {
                        warningEl.style.display = 'none'; // Hide warnings

                        if (angle <= 80 && nose_wrist_dist < 0.42) {
                            direction = 1;
                        }
                        
                        if (angle >= 160 && nose_wrist_dist < 0.75) {
                            if (direction === 1) {
                                count++;
                                direction = 0;
                            }
                        }
                        
                        countEl.innerText = `PUSHUPS: ${count}`;
                        stateEl.innerText = `State: ${direction === 1 ? 'BOTTOM' : 'TOP'}`;

                    } else {
                        // Standing up
                        direction = 0;
                        warningEl.style.display = 'block';
                        warningEl.innerText = 'STAND DETECTED';
                        stateEl.innerText = 'State: TOP';
                    }
                } else {
                    // Out of frame
                    direction = 0;
                    warningEl.style.display = 'block';
                    warningEl.innerText = 'OUT OF FRAME!';
                }
            }
            canvasCtx.restore();
        }

        // --- INITIALIZE GOOGLE'S AI ENGINE ---
        const pose = new Pose({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
        }});
        pose.setOptions({
            modelComplexity: 1,
            smoothLandmarks: true,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });
        pose.onResults(onResults);

        // --- TURN ON THE CAMERA ---
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await pose.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start();
    </script>
</body>
</html>